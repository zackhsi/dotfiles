#!/usr/bin/env bash
set -e

# Install salt from source.
if ! command -v salt-call > /dev/null; then
  salt_dir=~/oss/salt
  if ! [ -d $salt_dir ]; then
    git clone git@github.com:saltstack/salt.git $salt_dir
  fi
  pip install -e $salt_dir
fi

# Own /etc/salt.
owner="$(stat -c '%U' /etc/salt)"
if [[ "$owner" != "$USER" ]]; then
  echo "Chowning /etc/salt..."
  sudo chown -vR $USER /etc/salt
fi

# Configure salt
mkdir -p /etc/salt
cat << EOF > /etc/salt/minion
root_dir: /etc/salt/
pki_dir: /etc/salt/pki/minion
cachedir: /etc/salt/cache/minion
log_level: info
file_client: local
local: true
file_roots:
  base:
    - /Users/$USER/homespace/dotfiles/salt
    - /Users/$USER/homespace/dotfiles/sources
pillar_roots:
  base:
    - /Users/$USER/homespace/dotfiles/salt/pillar
EOF

command="$1"
if [ -n "$command" ]; then
  shift
else
  command=state.highstate
fi

DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
export DIR

salt-call --retcode-passthrough "$command" "$@"
