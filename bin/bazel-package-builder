#!/bin/bash
set -e

usage() {
  echo "Usage: $(basename "${BASH_SOURCE[0]}") [-v] TARGET";
  exit 1;
}

verbose=false
while getopts "v" opt; do
  case $opt in
    v) verbose=true;;
    *) usage;;
  esac
done
shift $((OPTIND -1))

absolute_filename=$1
relative_filename=$(realpath --relative-to=. "$absolute_filename")

absolute_directory=$(dirname "$absolute_filename")
while ! [ -f "$absolute_directory/BUILD" ]; do
  absolute_directory=$(dirname "$absolute_directory")
done
relative_directory=$(realpath --relative-to=. "$absolute_directory")

if $verbose; then
  ./bazel build "$relative_directory/..."
else
  ./bazel build "$relative_directory/..." 2>&1 | grep "$relative_filename"
fi
